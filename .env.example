# Agenticore — Environment Variables
# Copy to .env and fill in your values before running docker compose.
#
# Config resolution order (first found wins, explicit env vars always override):
#   1. Explicit env vars (already set in shell/process)
#   2. Project-local .env (this file, loaded by docker compose)
#   3. ~/.agenticore/config.yml (YAML config, lowest priority)
#
# Required for production: ANTHROPIC_API_KEY, GITHUB_TOKEN
# Required for full stack: REDIS_URL, POSTGRES_URL, OTEL endpoints
# Optional:                LANGFUSE_*, OAUTH_*, Kubernetes vars

# =============================================================================
# REDIS
# =============================================================================

# Job store. When unset, agenticore falls back to ~/.agenticore/jobs/ (files).
# Docker Compose: use the bundled redis container name.
# Production:     use your managed Redis URL (ElastiCache, Redis Cloud, etc.).
REDIS_URL=redis://redis:6379/0

# Key namespace prefix. All Redis keys are {prefix}:job:{id}, etc.
# Change this if you share a Redis instance with other services.
REDIS_KEY_PREFIX=agenticore

# =============================================================================
# POSTGRES (shared by agenticore + otel-collector services)
# =============================================================================

# Credentials used by both the postgres container and agenticore's OTEL sink.
# In production, set POSTGRES_URL to your managed database instead.
POSTGRES_USER=agenticore
POSTGRES_PASSWORD=changeme
POSTGRES_DB=agenticore
POSTGRES_URL=postgresql://agenticore:changeme@postgres:5432/agenticore

# =============================================================================
# AGENTICORE SERVER
# =============================================================================

# Transport mode:
#   "sse"   — HTTP server on AGENTICORE_PORT, exposes MCP + REST + OAuth
#   "stdio" — MCP pipe (Claude Code spawns it directly, no HTTP server)
AGENTICORE_TRANSPORT=sse

# Bind address and port for SSE/HTTP transport.
# Use 0.0.0.0 in Docker/K8s to accept external connections.
AGENTICORE_HOST=0.0.0.0
AGENTICORE_PORT=8200

# Comma-separated static API keys for authentication.
# When set, all endpoints except /health require X-Api-Key header or
# ?api_key= query param. Leave empty to disable auth (local dev only).
# In production, set at least one key — or use OAuth (see below).
AGENTICORE_API_KEYS=

# =============================================================================
# CLAUDE CODE
# =============================================================================

# Path to the Claude CLI binary. Must be installed in the container image.
AGENTICORE_CLAUDE_BINARY=claude

# Max runtime per job in seconds. Long coding tasks may need 3600+.
AGENTICORE_CLAUDE_TIMEOUT=3600

# Profile to use when the client does not specify one.
# Built-in profiles: "code" (autonomous coder + auto-PR), "review" (read-only).
AGENTICORE_DEFAULT_PROFILE=code

# Override the Claude config directory. Leave empty to use the profile-managed
# per-job directory (CLAUDE_CONFIG_DIR is set automatically by the runner).
# Only set this if you want to force a specific ~/.claude location.
# AGENTICORE_CLAUDE_CONFIG_DIR=

# =============================================================================
# REPOS
# =============================================================================

# Where cloned repositories are cached. Each repo maps to a deterministic
# subdirectory (sha256 of URL, 12 chars). Reused across jobs — only fetched
# on subsequent runs, not re-cloned.
AGENTICORE_REPOS_ROOT=/home/agenticore/agenticore-repos

# Max Claude Code subprocesses running in parallel. Scale up if your host
# has enough CPU/RAM and you expect concurrent job submissions.
AGENTICORE_MAX_PARALLEL_JOBS=3

# How long job records are kept in Redis (seconds). Default: 24h.
# File-based fallback jobs are never auto-expired.
AGENTICORE_JOB_TTL=86400

# =============================================================================
# OTEL OBSERVABILITY
# =============================================================================

# Master switch. Set to "false" to disable all telemetry (no OTEL vars
# are injected into the Claude subprocess).
AGENTICORE_OTEL_ENABLED=true

# OTEL Collector endpoint. In Docker Compose, use the container name.
# In production, point at your hosted collector or OTLP-compatible backend.
OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317

# Protocol for OTLP export: "grpc" (default, port 4317) or "http" (port 4318).
OTEL_EXPORTER_OTLP_PROTOCOL=grpc

# Include user prompt text in telemetry spans. Disable in regulated environments.
AGENTICORE_OTEL_LOG_PROMPTS=false

# Include tool call details (file paths, args) in telemetry spans.
AGENTICORE_OTEL_LOG_TOOL_DETAILS=true

# =============================================================================
# GITHUB (auto-PR)
# =============================================================================

# Personal access token or GitHub App token used by `gh pr create`.
# Required when profiles have auto_pr: true. Needs repo + pull_request scopes.
GITHUB_TOKEN=

# =============================================================================
# ANTHROPIC (Claude CLI)
# =============================================================================

# Your Anthropic API key. The Claude CLI reads this from the environment.
ANTHROPIC_API_KEY=

# Point Claude CLI at a LiteLLM proxy or custom gateway instead of api.anthropic.com.
# ANTHROPIC_BASE_URL=https://llm.example.com

# Pass custom headers to every Anthropic API request — JSON object format.
# Use for Cloudflare Access service tokens, internal auth headers, etc.
# ANTHROPIC_CUSTOM_HEADERS={"CF-Access-Client-Id":"...","CF-Access-Client-Secret":"..."}

# =============================================================================
# LANGFUSE (agent observability — optional)
# =============================================================================

# Langfuse receives data through two channels:
#   1. OTEL Collector → Langfuse via otlphttp (native Claude telemetry)
#   2. Langfuse SDK   → job traces + Claude session transcripts as spans
#
# For channel 1: set LANGFUSE_HOST + LANGFUSE_BASIC_AUTH in the collector config.
# For channel 2: set LANGFUSE_PUBLIC_KEY + LANGFUSE_SECRET_KEY here.
# Both channels are independent — you can use either or both.

LANGFUSE_HOST=https://cloud.langfuse.com

# SDK credentials (channel 2 — job-level traces + transcripts).
# Leave empty to disable SDK tracing; the runner continues without error.
LANGFUSE_PUBLIC_KEY=
LANGFUSE_SECRET_KEY=

# Collector credentials (channel 1 — native Claude OTEL export).
# Base64 encoding of "public_key:secret_key". Generate with:
#   echo -n "pk-lf-...:sk-lf-..." | base64
LANGFUSE_BASIC_AUTH=

# =============================================================================
# OAUTH 2.1 (optional — enables claude.ai and remote MCP client connections)
# =============================================================================

# Set OAUTH_ISSUER_URL to enable full OAuth 2.1 + PKCE for MCP clients.
# When set, the server advertises OAuth metadata at /.well-known/oauth-*
# and FastMCP handles the authorization_code + PKCE flow automatically.
# API key auth continues working alongside OAuth with no changes needed.
#
# Use your public-facing server URL (must be reachable by the client).
# OAUTH_ISSUER_URL=https://agenticore.example.com

# Resource server URL advertised in OAuth metadata.
# Defaults to {OAUTH_ISSUER_URL}/mcp — only override if your MCP endpoint
# is at a different path.
# OAUTH_RESOURCE_URL=

# Pre-configured client credentials (recommended for production).
# When set, dynamic registration returns these credentials — the server is
# "locked" to a single known client. Enter the same values in your MCP
# client's OAuth settings (e.g. claude.ai → "OAuth Client ID/Secret").
# When unset, dynamic registration is open — any client can register.
# OAUTH_CLIENT_ID=my-agenticore-client
# OAUTH_CLIENT_SECRET=generate-a-strong-random-secret-here

# Comma-separated allowed redirect URIs for the pre-configured client.
# Each MCP client has its own callback URL. claude.ai uses:
#   https://claude.ai/api/mcp/auth_callback
# OAUTH_ALLOWED_REDIRECT_URIS=https://claude.ai/api/mcp/auth_callback

# Space-separated OAuth scopes the client is allowed to request.
# claude.ai requests "claudeai". Leave empty to allow any scope.
# OAUTH_ALLOWED_SCOPES=claudeai

# =============================================================================
# KUBERNETES / SHARED FILESYSTEM (optional — multi-pod deployments)
# =============================================================================

# Set AGENTICORE_SHARED_FS_ROOT to enable Kubernetes mode.
# When set, profiles are materialized into {shared_root}/jobs/{job-id}/
# instead of the repo working directory, keeping repos clean and allowing
# any pod to inspect job artifacts after completion.
# In Docker Compose (single host), leave this unset.
# AGENTICORE_SHARED_FS_ROOT=/shared

# Override repo clone cache root. In Kubernetes, point at the shared PVC
# so all pods share the same clone cache (one clone per repo, not one per pod).
# Overrides AGENTICORE_REPOS_ROOT when set.
# AGENTICORE_REPOS_ROOT=/shared/repos

# Directory for job state files (Redis fallback + job config dirs).
# Defaults to ~/.agenticore/jobs/ when unset.
# In Kubernetes, point at the shared PVC so any pod can read job state.
# AGENTICORE_JOBS_DIR=/shared/job-state

# Pod name for auditing — records which pod ran which job.
# In Kubernetes, inject via Downward API (see k8s/statefulset.yaml).
# Defaults to hostname when unset.
# AGENTICORE_POD_NAME=agenticore-0

# =============================================================================
# AGENTIHOOKS (optional — external profile and hook library)
# =============================================================================

# Path to a cloned agentihooks repository. When set, agenticore loads
# additional profiles from {path}/profiles/ alongside the bundled defaults.
# Profile priority: ~/.agenticore/profiles/ > agentihooks > defaults.
# AGENTICORE_AGENTIHOOKS_PATH=/app

# =============================================================================
# CLOUDFLARE ACCESS (optional — when services are behind CF Zero Trust)
# =============================================================================

# Service token credentials for reaching internal services protected by
# Cloudflare Access (LiteLLM proxy, internal OTEL collector, etc.).
# Pass these via ANTHROPIC_CUSTOM_HEADERS to the Claude CLI, or use
# directly in HTTP clients that call CF-protected endpoints.
#
# Get values from: Zero Trust → Access → Service Auth → Service Tokens
# CF_ACCESS_CLIENT_ID=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.access
# CF_ACCESS_CLIENT_SECRET=yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
