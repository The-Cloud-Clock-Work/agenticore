name: Smoke Test

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test deps
        run: pip install httpx pytest pytest-timeout langfuse

      # ── Probe Anthropic endpoints (BASE → FALLBACK → fail) ──────────────
      - name: Probe Anthropic endpoints
        id: anthropic
        env:
          BASE_URL: ${{ vars.ANTHROPIC_URL_BASE }}
          FALLBACK_URL: ${{ vars.ANTHROPIC_URL_FALLBACK }}
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          echo "Probing BASE: ${BASE_URL}"
          HTTP_CODE=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" \
            -H "CF-Access-Client-Id: ${CF_ACCESS_CLIENT_ID}" \
            -H "CF-Access-Client-Secret: ${CF_ACCESS_CLIENT_SECRET}" \
            "${BASE_URL}" 2>/dev/null || true)
          echo "  HTTP status: ${HTTP_CODE}"

          if [[ "$HTTP_CODE" =~ ^2 ]]; then
            echo "BASE endpoint reachable"
            echo "selected=base" >> "$GITHUB_OUTPUT"
            echo "url=${BASE_URL}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "BASE returned ${HTTP_CODE}, trying FALLBACK: ${FALLBACK_URL}"
          HTTP_CODE=$(curl -s --max-time 10 -o /dev/null -w "%{http_code}" "${FALLBACK_URL}" 2>/dev/null || true)
          echo "  HTTP status: ${HTTP_CODE}"

          if [[ "$HTTP_CODE" =~ ^2 ]]; then
            echo "FALLBACK endpoint reachable"
            echo "selected=fallback" >> "$GITHUB_OUTPUT"
            echo "url=${FALLBACK_URL}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::error::Both Anthropic endpoints unreachable (BASE: ${HTTP_CODE})"
          exit 1

      - name: Resolve API key
        id: resolve_key
        env:
          TOKEN_BASE: ${{ secrets.ANTHROPIC_TOKEN_BASE }}
          TOKEN_FALLBACK: ${{ secrets.ANTHROPIC_TOKEN_FALLBACK }}
        run: |
          if [ "${{ steps.anthropic.outputs.selected }}" = "base" ]; then
            echo "api_key=${TOKEN_BASE}" >> "$GITHUB_OUTPUT"
          else
            echo "api_key=${TOKEN_FALLBACK}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create .env
        run: |
          cp .env.example .env
          cat >> .env <<EOF
          LANGFUSE_HOST=${{ secrets.LANGFUSE_HOST }}
          LANGFUSE_PUBLIC_KEY=${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY=${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASIC_AUTH=${{ secrets.LANGFUSE_BASIC_AUTH }}
          CF_ACCESS_CLIENT_ID=${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET=${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          ANTHROPIC_API_KEY=${{ steps.resolve_key.outputs.api_key }}
          ANTHROPIC_BASE_URL=${{ steps.anthropic.outputs.url }}
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          EOF

          # Build ANTHROPIC_CUSTOM_HEADERS for Claude CLI when using CF Access-protected proxy
          if [ "${{ steps.anthropic.outputs.selected }}" = "base" ]; then
            echo 'ANTHROPIC_CUSTOM_HEADERS={"CF-Access-Client-Id":"${{ secrets.CF_ACCESS_CLIENT_ID }}","CF-Access-Client-Secret":"${{ secrets.CF_ACCESS_CLIENT_SECRET }}"}' >> .env
          fi

      - name: Start Docker stack
        run: docker compose up --build -d

      - name: Wait for services
        run: |
          echo "Waiting for Redis..."
          for i in $(seq 1 30); do
            docker compose exec -T redis redis-cli ping 2>/dev/null | grep -q PONG && break
            sleep 2
          done
          echo "Waiting for Postgres..."
          for i in $(seq 1 30); do
            docker compose exec -T postgres pg_isready -U agenticore 2>/dev/null && break
            sleep 2
          done
          echo "Waiting for agenticore..."
          for i in $(seq 1 30); do
            curl -sf http://localhost:8200/health && break || sleep 2
          done
          echo "All services ready"

      - name: Run smoke test
        env:
          SMOKE_AGENTICORE_URL: http://localhost:8200
          SMOKE_DATASET_REPO: https://github.com/The-Cloud-Clock-Work/bridge-smoke-dataset
          LANGFUSE_HOST: ${{ secrets.LANGFUSE_HOST }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          SMOKE_REPORT_PATH: smoke-report.md
        run: pytest tests/smoke/test_pipeline.py -v --timeout=300

      - name: Publish test report
        if: always()
        run: |
          if [ -f smoke-report.md ]; then
            cat smoke-report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-report
          path: smoke-report.md
          if-no-files-found: ignore

      - name: Dump job details
        if: always()
        run: |
          JOB_ID=$(curl -sf http://localhost:8200/jobs 2>/dev/null | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          jobs = data.get('jobs', [])
          if jobs: print(jobs[0].get('id', ''))
          " 2>/dev/null)
          if [ -n "$JOB_ID" ]; then
            echo "=== Job $JOB_ID ==="
            curl -sf "http://localhost:8200/jobs/$JOB_ID" | python3 -m json.tool
          else
            echo "No jobs found"
          fi

      - name: Check OTEL collector logs
        if: always()
        run: docker compose logs otel-collector 2>&1 | tail -50

      - name: Dump agenticore logs
        if: always()
        run: docker compose logs agenticore 2>&1 | tail -100

      - name: Teardown
        if: always()
        run: docker compose down -v
